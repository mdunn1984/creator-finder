<script>
  const $ = id => document.getElementById(id);

  function buildQuery() {
    const keywords = $("keywords").value.trim();
    const location = $("location").value.trim();
    const extras   = $("extras").value.trim();
    const platforms = Array.from(document.querySelectorAll(".pf:checked")).map(p=>`site:${p.value}`);

    const parts = [];
    if (keywords) parts.push(keywords);
    if (location) parts.push(`("${location}")`);
    if (extras)   parts.push(extras);
    if (platforms.length) parts.push("(" + platforms.join(" OR ") + ")");
    return parts.join(" ").replace(/\s+/g, " ").trim()
      || "site:instagram.com OR site:tiktok.com OR site:youtube.com";
  }

  function runSearch(q, attempts=0) {
    const maxAttempts = 25; // ~5s
    const ready = window.google
      && google.search && google.search.cse && google.search.cse.element
      && google.search.cse.element.getElement('standard0');

    if (ready) {
      try { google.search.cse.element.getElement('standard0').execute(q); return; } catch(e){}
    }
    if (attempts < maxAttempts) setTimeout(()=>runSearch(q, attempts+1), 200);
  }

  $("run").addEventListener("click", (e)=>{ e.preventDefault(); runSearch(buildQuery()); });
  $("reset").addEventListener("click", (e)=>{
    e.preventDefault();
    $("keywords").value = $("location").value = $("extras").value = "";
    document.querySelectorAll(".pf").forEach(i=>i.checked = true);
    runSearch("site:instagram.com OR site:tiktok.com OR site:youtube.com");
  });

  // Render results element explicitly, then prime once
  window.__gcse = {
    parsetags: 'explicit',
    callback: function() {
      try {
        google.search.cse.element.render({
          div: document.querySelector('.gcse-searchresults-only'),
          tag: 'searchresults-only',
          attributes: { enableOrderBy: true }
        });
        runSearch("test"); // prime
      } catch(e) { console.error(e); }
    }
  };
</script>

</html>


